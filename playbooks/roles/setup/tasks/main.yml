- name: Install system services
  shell: "xbps-install -Sy {{' '.join(pkgs) }}"
  vars:
    pkgs:
      - socklog-void
      - cronie
      - libnfs
      - nfs-utils
      - snapper
      - dbus
      - elogind
      - wireguard-tools
      - tailscale
      - grub-btrfs
      - grub-btrfs-runit


- name: Enable system services
  ansible.builtin.file:
    src: "/etc/sv/{{item}}"
    dest: "/etc/runit/runsvdir/current/{{item}}"
    state: link
  with_items:
    - cronie
    - rpcbind
    - statd
    - nfs-server
    - socklog-unix
    - nanoklogd
    - snapperd
    - dbus
    - elogind
    - grub-btrfs

- name: Create service directories 
  ansible.builtin.file:
    path: "/etc/sv/{{item.name}}"
    state: directory
    owner: root
    group: root
    mode: 0755
  with_items: "{{services}}"

- name: Create service logger directories 
  ansible.builtin.file:
    path: "/etc/sv/{{item.name}}/log"
    state: directory
    owner: root
    group: root
    mode: 0755
  with_items: "{{services}}"

- name: Install service templates
  ansible.builtin.template:
    src: "{{role_path}}/templates/sv/{{item.name}}/run.j2"
    dest: "/etc/sv/{{item.name}}/run"
    mode: 0750
    owner: root
    group: root
  with_items: "{{services}}"

- name: Install service templates
  ansible.builtin.template:
    src: "{{role_path}}/templates/sv/{{item.name}}/log/run.j2"
    dest: "/etc/sv/{{item.name}}/log/run"
    mode: 0750
    owner: root
    group: root
  when: "{{item.enabled}}"
  with_items: "{{ services }}"